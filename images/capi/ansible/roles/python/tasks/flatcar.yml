# Copyright 2018 The Kubernetes Authors.

# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at

# http://www.apache.org/licenses/LICENSE-2.0

# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---
- name: Check if pypy is installed
  ansible.builtin.raw: "[ -f {{ pypy_install_path }}/pypy/bin/pypy ] && echo 'true' || echo 'false'"
  register: pypy_installed

- name: Install pypy
  when:
    - pypy_installed.stdout_lines[0] == "false"
  vars:
    pypy_url_base: https://downloads.python.org/pypy
    pypy_url_path: pypy{{ pypy_python_version }}-v{{ pypy_version }}-{{ arch_label }}.tar.bz2
  block:
    - raw: uname -m
      register: arch_cmd
    - name: Normalize architecture
      set_fact:
        arch_label: >-
          {{ 'aarch64' if arch_cmd.stdout in ['aarch64', 'arm64'] else
             'linux64' if arch_cmd.stdout in ['x86_64', 'amd64'] else
             arch_cmd.stdout }}
    - debug:
        msg: "{{ arch_cmd }}"
    - name: Download pypy archive
      ansible.builtin.raw: curl {{ pypy_url_base }}/{{ pypy_url_path }} -L --output {{ pypy_download_path }}
    - name: Extract archive
      ansible.builtin.raw: tar -xjf {{ pypy_download_path }} -C {{ pypy_install_path }}
    - name: Rename pypy folder
      ansible.builtin.raw: mv {{ pypy_install_path }}/pypy{{ pypy_python_version }}-v{{ pypy_version }}-{{ arch_label }}/ {{ pypy_install_path }}/pypy
    - name: Delete downloaded archive
      ansible.builtin.raw: rm -f {{ pypy_download_path }}
